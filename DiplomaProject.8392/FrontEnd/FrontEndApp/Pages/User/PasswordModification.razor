@page "/account/password"
@inherits Components.UserBaseComponent
@layout UserFormLayout
@inject AppState _appState
<EditForm OnValidSubmit="@ChangePassword" Model="_model" class="contactform">
    <DataAnnotationsValidator />
    @if (_response != null)
    {
        <p class="font-weight-bold text-danger">@_response.Message</p>
        @if (_response.Errors != null && _response.Errors.Length != 0)
        {
            @foreach (var error in _response.Errors)
            {
                <p class="font-weight-bold text-danger">@error.Message</p>
            }
        }

    }
    <div class="aa-single-field">
        <label>Password <span class="required">*</span></label>
        <InputText class="form__input" type="password" @bind-Value="_model.Password" />
        <div class="font-weight-bold text-danger">
            <ValidationMessage For="() => _model.Password" />
        </div>
    </div>
    <div class="aa-single-field">
        <label for="confirm-password">Confirm Password <span class="required">*</span></label>
        <InputText class="form__input" type="password" @bind-Value="_model.ConfirmPassword" />
        <div class="font-weight-bold text-danger">
            <ValidationMessage For="() => _model.ConfirmPassword" />
        </div>
    </div>
    <div class="aa-single-submit">
        <input type="submit" value="Reset password">
    </div>
</EditForm>

@code {
    private ChangePassword _model = new ChangePassword();
    private Response _response;
    protected override async Task OnInitializedAsync()
    {
        _appState.SetPageTitle("Password modification");
        if(!_authState.isAuthenticated)
        {
            _navManager.NavigateTo("/login");
        } else
        {
            _model.Id = (long)(await _authService.GetLoggedUserId());
        }
    }
    private async Task ChangePassword()
    {
        _response = await _service.ChangePasswordAsync
            (_model, () => _navManager.NavigateTo("/account"));
    }
}
